<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email and OTP Verification</title>
    <!-- External CSS -->
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
        }
        .container {
            background-color: #fff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            width: 300px;
        }
        h2 {
            margin-bottom: 20px;
            text-align: center;
        }
        label {
            font-size: 1rem;
            margin-bottom: 10px;
            display: block;
        }
        input[type="email"], input[type="text"] {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
            border: 1px solid #ccc;
            font-size: 1rem;
        }
        button {
            width: 100%;
            padding: 10px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 1rem;
            cursor: pointer;
        }
        button:hover {
            background-color: #218838;
        }
        .hidden {
            display: none;
        }
        .error-message {
            color: red;
            font-size: 0.9rem;
            margin-bottom: 15px;
        }
        .timer {
            text-align: center;
            margin-top: 10px;
            font-weight: bold;
        }
    </style>
</head>
<body>

<div class="container">
    <h2>Email and OTP Verification</h2>

    <!-- Email Form -->
    <form id="emailForm">
        <label for="email">Enter your email:</label>
        <input type="email" id="email" name="email" required placeholder="Your email address">
        <div id="emailError" class="error-message hidden"></div> <!-- Error message for invalid email -->
        <button type="submit">Submit</button>
    </form>

    <!-- OTP Input Section (Initially Hidden) -->
    <div id="otpSection" class="hidden">
        <label for="otp">Enter OTP:</label>
        <input type="text" id="otp" name="otp" required placeholder="Enter OTP" maxlength="6">
        <div id="otpError" class="error-message hidden"></div> <!-- Error message for invalid OTP -->
        <button id="verifyOtpBtn">Verify OTP</button>
        <div class="timer" id="timer">02:00</div>
    </div>
</div>

<!-- JavaScript -->
<script>
    const emailForm = document.getElementById('emailForm');
    const otpSection = document.getElementById('otpSection');
    const emailError = document.getElementById('emailError');
    const otpError = document.getElementById('otpError');
    const timerDisplay = document.getElementById('timer');
    let countdown;

    // Function to show error messages
    function showError(element, message) {
        element.textContent = message;
        element.classList.remove('hidden');
    }

    // Function to hide error messages
    function hideError(element) {
        element.classList.add('hidden');
        element.textContent = '';
    }

    // Handle Email Form Submission
    emailForm.addEventListener('submit', function(event) {
        event.preventDefault();

        const email = document.getElementById('email').value;

        // Clear previous error messages
        hideError(emailError);

        // Send POST request to /changePassword with the email
        fetch(`/changePassword?email=${encodeURIComponent(email)}`, {
            method: 'POST',
        })
            .then(response => {
                if (response.ok) {
                    // If the response is successful (response.ok is true), show OTP input and start the timer
                    // Hide email form and show OTP section
                    emailForm.classList.add('hidden');
                    otpSection.classList.remove('hidden');

                    // Start countdown timer (2 minutes)
                    startTimer(120);
                } else {
                    // Show invalid email message next to email input
                    showError(emailError, 'Invalid email. Please try again.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showError(emailError, 'There was an error submitting the email.');
            });
    });

    // Timer function
    function startTimer(duration) {
        let timer = duration, minutes, seconds;

        countdown = setInterval(function () {
            minutes = parseInt(timer / 60, 10);
            seconds = parseInt(timer % 60, 10);

            minutes = minutes < 10 ? "0" + minutes : minutes;
            seconds = seconds < 10 ? "0" + seconds : seconds;

            timerDisplay.textContent = minutes + ":" + seconds;

            if (--timer < 0) {
                clearInterval(countdown);
                timerDisplay.textContent = "Time's up!";
                document.getElementById('otp').disabled = true; // Disable OTP input after timer ends
            }
        }, 1000);
    }

    // Handle OTP verification button
    document.getElementById('verifyOtpBtn').addEventListener('click', function() {
        const otp = document.getElementById('otp').value;
        const email = document.getElementById('email').value;

        // Clear previous error messages
        hideError(otpError);

        clearInterval(countdown); // Stop the timer after OTP submission

        // Send POST request with email and OTP as request parameters
        fetch(`/otp?email=${encodeURIComponent(email)}&otp=${encodeURIComponent(otp)}`, {
            method: 'POST',
        })
            .then(response => {
                if (response.ok) {
                    // If the response is successful (response.ok is true), show success message
                    window.location.href = '/newPassword?email='+email;
                } else {
                    // Show invalid OTP message next to OTP input
                    showError(otpError, 'Invalid OTP. Please try again.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showError(otpError, 'An error occurred while verifying the OTP.');
            });
    });
</script>

</body>
</html>
